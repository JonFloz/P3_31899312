name: CI/CD - Build, Test & Deploy to Render

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master

env:
  RENDER_SERVICE_ID: ${{ srv-d3p6igbuibrs73eqo4k0  }}
  RENDER_API_KEY: ${{ secrets.RENDER }}

jobs:
  # ============================================
  # FASE 1: ValidaciÃ³n del Backend
  # ============================================
  backend-test:
    name: ğŸ§ª Test Backend
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        node-version: '20.15.1'
      fail-fast: false
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'api/src/package-lock.json'
      
      - name: ğŸ“¥ Instalar dependencias Backend
        working-directory: ./api/src
        run: |
          echo "Installing backend dependencies..."
          npm ci --prefer-offline --no-audit
      
      - name: ğŸ§ª Ejecutar tests Backend
        working-directory: ./api/src
        run: |
          echo "Running tests..."
          npm test -- --passWithNoTests --coverage
        env:
          NODE_ENV: test
          DATABASE_URL: sqlite::memory:
      
      - name: ğŸ“Š Covertura de tests
        working-directory: ./api/src
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "âœ… Tests with coverage generated"
          fi
        continue-on-error: true
      
      - name: ğŸ” Lint (ESLint)
        working-directory: ./api/src
        run: npm run lint --if-present
        continue-on-error: true
      
      - name: ğŸ“ Verificar package.json
        working-directory: ./api/src
        run: npm list --depth=0
        continue-on-error: true

  # ============================================
  # FASE 2: Build del Frontend
  # ============================================
  frontend-build:
    name: ğŸ—ï¸ Build Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.15.1'
          cache: 'npm'
          cache-dependency-path: 'web/package-lock.json'
      
      - name: ğŸ“¥ Instalar dependencias Frontend
        working-directory: ./web
        run: |
          echo "Installing frontend dependencies..."
          npm ci --prefer-offline --no-audit
      
      - name: ğŸ”¨ Build Frontend
        working-directory: ./web
        run: |
          echo "Building frontend..."
          npm run build
        env:
          VITE_API_URL: ${{ secrets.RENDER_API_BASE_URL || 'https://p3-31899312.onrender.com' }}
          VITE_ENV: production
          NODE_ENV: production
      
      - name: âœ… Verificar build
        working-directory: ./web
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Build directory exists"
            du -sh dist
            ls -la dist | head -10
          else
            echo "âŒ Build directory NOT found!"
            exit 1
          fi
      
      - name: ğŸ“¤ Guardar Frontend Build
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: web/dist
          retention-days: 1
          if-no-files-found: error

  # ============================================
  # FASE 3: ValidaciÃ³n de Security
  # ============================================
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ” npm audit (Backend)
        working-directory: ./api/src
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: ğŸ” npm audit (Frontend)
        working-directory: ./web
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # ============================================
  # FASE 4: Deploy a Render
  # ============================================
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-build, security-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 20
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ”‘ Verificar Render API Key
        run: |
          if [ -z "${{ secrets.RENDER_API_KEY }}" ]; then
            echo "âŒ RENDER_API_KEY no estÃ¡ configurado"
            exit 1
          fi
          if [ -z "${{ secrets.RENDER_SERVICE_ID }}" ]; then
            echo "âŒ RENDER_SERVICE_ID no estÃ¡ configurado"
            exit 1
          fi
          echo "âœ… Credenciales verificadas"
      
      - name: ğŸ“¤ Trigger Deploy en Render
        run: |
          echo "Enviando request de deploy a Render..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json")
          
          status_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response Status: $status_code"
          echo "Response Body: $body"
          
          if [ "$status_code" != "200" ] && [ "$status_code" != "201" ]; then
            echo "âŒ Deploy API call failed with status $status_code"
            exit 1
          fi
          echo "âœ… Deploy initiated successfully"
      
      - name: â³ Esperar a que Render se despliegue
        run: |
          echo "Waiting for Render deployment (120 seconds)..."
          sleep 120
          echo "âœ… Deployment window complete"

  # ============================================
  # FASE 5: VerificaciÃ³n Post-Deploy
  # ============================================
  verify-deployment:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ”— Verificar que el sitio estÃ¡ online
        run: |
          HEALTH_URL="${{ secrets.RENDER_API_BASE_URL || 'https://p3-31899312.onrender.com' }}"
          
          echo "Checking health of: $HEALTH_URL"
          
          max_attempts=5
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts..."
            
            if curl -f -m 10 "$HEALTH_URL" > /dev/null 2>&1; then
              echo "âœ… Sitio estÃ¡ ONLINE"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "â³ Esperando 15 segundos..."
              sleep 15
            fi
          done
          
          echo "âš ï¸ Sitio no responde despuÃ©s de $max_attempts intentos"
          echo "Revisar logs en Render Dashboard"
          exit 1
      
      - name: ğŸ“Š API Health Check
        run: |
          API_URL="${{ secrets.RENDER_API_BASE_URL || 'https://p3-31899312.onrender.com' }}/api"
          
          echo "Testing API endpoints..."
          
          # Test basic connectivity
          if curl -f -m 10 "${API_URL}/auth/login" -X OPTIONS > /dev/null 2>&1; then
            echo "âœ… API is responding"
          else
            echo "âš ï¸ API might be slow to respond (normal for first deploy)"
          fi
        continue-on-error: true

  # ============================================
  # FASE 6: NotificaciÃ³n Final
  # ============================================
  notify:
    name: ğŸ“§ Notify Status
    runs-on: ubuntu-latest
    needs: [deploy, verify-deployment]
    if: always()
    
    steps:
      - name: âœ… Deploy Exitoso
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     âœ… DEPLOY COMPLETADO EXITOSAMENTE     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Resumen:"
          echo "  â€¢ Backend: Testeado âœ…"
          echo "  â€¢ Frontend: Compilado âœ…"
          echo "  â€¢ Render: Deploy enviado âœ…"
          echo "  â€¢ VerificaciÃ³n: Online âœ…"
          echo ""
          echo "ğŸ”— Sitio: ${{ secrets.RENDER_API_BASE_URL || 'https://p3-31899312.onrender.com' }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
      
      - name: âŒ Deploy Fallido
        if: failure()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          âŒ DEPLOY FALLÃ“                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ” Revisar:"
          echo "  1. GitHub Actions Logs (arriba)"
          echo "  2. Render Dashboard Logs"
          echo "  3. Variables de entorno en Render"
          echo "  4. Secrets en GitHub"
          echo ""
          exit 1
