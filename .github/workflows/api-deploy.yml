name: Node.js CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # ============================================
  # FASE 1: ValidaciÃ³n del Backend
  # ============================================
  backend-test:
    name: ğŸ§ª Test Backend
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.15.1'
          cache: 'npm'
      
      - name: ğŸ“¥ Instalar dependencias Backend
        run: npm install
      
      - name: ğŸ”§ Crear archivo .env
        run: |
          echo "DATABASE_PATH=./config/mi_base_de_datos.sqlite" >> .env
          echo "JWT_SECRET=1234567890@@@@@1234567890!@#$%^&*()" >> .env
          echo "NODE_ENV=development" >> .env
          echo "TEST_DATABASE_PATH=:memory:" >> .env
      
      - name: ğŸ§ª Ejecutar tests Backend
        run: npm test
        env:
          NODE_ENV: test
          DATABASE_PATH: ':memory:'

  # ============================================
  # FASE 2: Build del Frontend
  # ============================================
  frontend-build:
    name: ğŸ—ï¸ Build Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.15.1'
          cache: 'npm'
          cache-dependency-path: 'web/package-lock.json'
      
      - name: ğŸ“¥ Instalar dependencias Frontend
        working-directory: ./web
        run: npm install
      
      - name: ğŸ”¨ Build Frontend
        working-directory: ./web
        run: npm run build
        env:
          VITE_API_URL: https://p3-31899312.onrender.com
          NODE_ENV: production
      
      - name: âœ… Verificar build
        working-directory: ./web
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Build directory exists"
            du -sh dist
          else
            echo "âŒ Build directory NOT found!"
            exit 1
          fi
      
      - name: ğŸ“¤ Guardar Frontend Build
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: web/dist
          retention-days: 1
          if-no-files-found: error

  # ============================================
  # FASE 3: Deploy a Render
  # ============================================
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 20
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ“¤ Trigger Deploy en Render
        run: |
          echo "Enviando request de deploy a Render..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.render.com/deploy/srv-${{ srv-d3p6igbuibrs73eqo4k0 }}" \
            -H "Authorization: Bearer ${{ secrets.RENDER }}" \
            -H "Content-Type: application/json")
          
          status_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response Status: $status_code"
          echo "Response Body: $body"
          
          if [ "$status_code" != "200" ] && [ "$status_code" != "201" ]; then
            echo "âŒ Deploy failed with status $status_code"
            exit 1
          fi
          echo "âœ… Deploy initiated successfully"
      
      - name: â³ Esperar a que Render se despliegue
        run: sleep 120

  # ============================================
  # FASE 4: VerificaciÃ³n Post-Deploy
  # ============================================
  verify-deployment:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ”— Verificar que el sitio estÃ¡ online
        run: |
          HEALTH_URL="https://p3-31899312.onrender.com"
          
          echo "Checking health of: $HEALTH_URL"
          
          max_attempts=5
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts..."
            
            if curl -f -m 10 "$HEALTH_URL" > /dev/null 2>&1; then
              echo "âœ… Sitio estÃ¡ ONLINE"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "â³ Esperando 15 segundos..."
              sleep 15
            fi
          done
          
          echo "âš ï¸ Sitio no responde despuÃ©s de $max_attempts intentos"
          exit 1

  # ============================================
  # FASE 5: NotificaciÃ³n Final
  # ============================================
  notify:
    name: ğŸ“§ Notify Status
    runs-on: ubuntu-latest
    needs: [deploy, verify-deployment]
    if: always()
    
    steps:
      - name: âœ… Deploy Exitoso
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     âœ… DEPLOY COMPLETADO EXITOSAMENTE     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Resumen:"
          echo "  â€¢ Backend: Testeado âœ…"
          echo "  â€¢ Frontend: Compilado âœ…"
          echo "  â€¢ Render: Deploy enviado âœ…"
          echo "  â€¢ VerificaciÃ³n: Online âœ…"
          echo ""
          echo "ğŸ”— Sitio: https://p3-31899312.onrender.com"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
      
      - name: âŒ Deploy Fallido
        if: failure()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          âŒ DEPLOY FALLÃ“                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ” Revisar:"
          echo "  1. GitHub Actions Logs"
          echo "  2. Render Dashboard Logs"
          echo "  3. Variables de entorno en Render"
          echo "  4. Secrets en GitHub (RENDER_API_KEY, RENDER_SERVICE_ID)"
          echo ""
jobs:
  # ============================================
  # FASE 1: ValidaciÃ³n del Backend
  # ============================================
  backend-test:
    name: ğŸ§ª Test Backend
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.15.1'
          cache: 'npm'
      
      - name: ğŸ“¥ Instalar dependencias Backend
        run: npm install
      
      - name: ğŸ”§ Crear archivo .env
        run: |
          echo "DATABASE_PATH=./config/mi_base_de_datos.sqlite" >> .env
          echo "JWT_SECRET=1234567890@@@@@1234567890!@#$%^&*()" >> .env
          echo "NODE_ENV=development" >> .env
          echo "TEST_DATABASE_PATH=:memory:" >> .env
      
      - name: ğŸ§ª Ejecutar tests Backend
        run: npm test
        env:
          NODE_ENV: test
          DATABASE_PATH: ':memory:'

  # ============================================
  # FASE 2: Build del Frontend
  # ============================================
  frontend-build:
    name: ğŸ—ï¸ Build Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.15.1'
          cache: 'npm'
          cache-dependency-path: 'web/package-lock.json'
      
      - name: ğŸ“¥ Instalar dependencias Frontend
        working-directory: ./web
        run: npm install
      
      - name: ğŸ”¨ Build Frontend
        working-directory: ./web
        run: npm run build
        env:
          VITE_API_URL: https://p3-31899312.onrender.com
          NODE_ENV: production
      
      - name: âœ… Verificar build
        working-directory: ./web
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Build directory exists"
            du -sh dist
          else
            echo "âŒ Build directory NOT found!"
            exit 1
          fi
      
      - name: ğŸ“¤ Guardar Frontend Build
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: web/dist
          retention-days: 1
          if-no-files-found: error

  # ============================================
  # FASE 3: Deploy a Render
  # ============================================
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 20
    
    steps:
      - name: âœ… Checkout cÃ³digo
        uses: actions/checkout@v3
      
      - name: ğŸ“¤ Trigger Deploy en Render
        run: |
          echo "Enviando request de deploy a Render..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json")
          
          status_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response Status: $status_code"
          echo "Response Body: $body"
          
          if [ "$status_code" != "200" ] && [ "$status_code" != "201" ]; then
            echo "âŒ Deploy failed with status $status_code"
            exit 1
          fi
          echo "âœ… Deploy initiated successfully"
      
      - name: â³ Esperar a que Render se despliegue
        run: sleep 120

  # ============================================
  # FASE 4: VerificaciÃ³n Post-Deploy
  # ============================================
  verify-deployment:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ”— Verificar que el sitio estÃ¡ online
        run: |
          HEALTH_URL="https://p3-31899312.onrender.com"
          
          echo "Checking health of: $HEALTH_URL"
          
          max_attempts=5
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts..."
            
            if curl -f -m 10 "$HEALTH_URL" > /dev/null 2>&1; then
              echo "âœ… Sitio estÃ¡ ONLINE"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "â³ Esperando 15 segundos..."
              sleep 15
            fi
          done
          
          echo "âš ï¸ Sitio no responde despuÃ©s de $max_attempts intentos"
          exit 1

  # ============================================
  # FASE 5: NotificaciÃ³n Final
  # ============================================
  notify:
    name: ğŸ“§ Notify Status
    runs-on: ubuntu-latest
    needs: [deploy, verify-deployment]
    if: always()
    
    steps:
      - name: âœ… Deploy Exitoso
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     âœ… DEPLOY COMPLETADO EXITOSAMENTE     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Resumen:"
          echo "  â€¢ Backend: Testeado âœ…"
          echo "  â€¢ Frontend: Compilado âœ…"
          echo "  â€¢ Render: Deploy enviado âœ…"
          echo "  â€¢ VerificaciÃ³n: Online âœ…"
          echo ""
          echo "ğŸ”— Sitio: https://p3-31899312.onrender.com"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
      
      - name: âŒ Deploy Fallido
        if: failure()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          âŒ DEPLOY FALLÃ“                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ” Revisar:"
          echo "  1. GitHub Actions Logs"
          echo "  2. Render Dashboard Logs"
          echo "  3. Variables de entorno en Render"
          echo "  4. Secrets en GitHub (RENDER_API_KEY, RENDER_SERVICE_ID)"
          echo ""
          exit 1
